
---
- name: Create AWS EC2 Instance
  hosts: local
  connection: local
  gather_facts: false
  vars:
    keypair        : aws-medvedev
    instance_type  : t2.micro
    image          : ami-015c25ad8763b2f11
    region         : eu-central-1
    count          : 2
    security_group : Ansible-SecurityGroup
    aws_access_key : AKIATVGQC3MC2KTOE265
    aws_secret_key : 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

  tasks:
    - name: Create a security group with Port 22 and 80 open to 0.0.0.0/0
      ec2_group:
         name       : "{{ security_group }}"
         description: Security Group for Servers with port 22,80,443 open
         region     : "{{ region }}"
         rules:
           - proto    : tcp
             from_port: 22
             to_port  : 22
             cidr_ip  : 0.0.0.0/0
           - proto    : tcp
             from_port: 80
             to_port  : 80
             cidr_ip  : 0.0.0.0/0
           - proto    : tcp
             from_port: 443
             to_port  : 443
             cidr_ip  : 0.0.0.0/0
         rules_egress:
           - proto  : all
             cidr_ip: 0.0.0.0/0
         aws_access_key: "{{ aws_access_key }}"
         aws_secret_key: "{{ aws_secret_key }}"
    
    - name: Create new AWS EC2 Server
      ec2:
        key_name     : "{{ keypair }}"
        instance_type: "{{ instance_type }}"
        image        : "{{ image }}"
        group        : "{{ security_group }}"
        region       : "{{ region }}"
        instance_tags:
          Name: AnsibleDeployment
          Type: AnsibleEC2-test
        count        : "{{ count }}"
        wait         : true
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: ec2

    - name: Print all ec2 variables
      debug: var=ec2